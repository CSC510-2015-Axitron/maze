function getNextMaze(){for(var e=Object.keys(mazeDirectory),t=[];currentLevel<e.length;){if(t=mazeDirectory[e[currentLevel]],currentMaze<t.length-1)return++currentMaze,"./levels/"+e[currentLevel]+"/"+t[currentMaze]+".json";++currentLevel,currentMaze=-1}return currentLevel=0,getNextMaze()}function updateStatus(e){e.hasPlayerWon()&&(soundWizzard.stopMusic(),soundWizzard.playWinner(),e.userData.TimerOff(),inputLock=mouseAction.inputLock=!0,setTimeout(function(){$("#dsp_score").text(e.gameData.getScore()),localDB?AMaze.model.load(currentMazeFile=getNextMaze(),setGameCanvas):AMaze.model.inject(remoteDB.getNextMaze(),setGameCanvas),soundWizzard.playMusic(),inputLock=mouseAction.inputLock=!1},soundWizzard.winnerPause)),soundWizzard.playStep(),e.userData.keepStep(),$("#dsp_steps").text(e.userData.step)}function resetStatus(){$("#dsp_steps").text(0),$("#dsp_time").text("00:00"),$("#dsp_level").text(currentMaze)}function userData(e){var t=e,s=0,n;this.step=0,this.pad=function(e,t){for(var s=e+"";s.length<t;)s="0"+s;return s};var a=function(){return(Date.now()-t)/1e3};this.getMinSec=function(){var e=Math.floor(a()),t=Math.floor(e/60),s=e-60*t;return this.pad(t,2)+":"+this.pad(s,2)},this.TimerOff=function(){s=-1,gameData.keepStep(this.step),gameData.keepTime(a())},this.TimerOn=function(){s=0},this.keepStep=function(){this.step++,this.step>999&&(this.step=999)},this.displayMinSec=function(){-1!=s&&(s>10?(s=0,n!=(n=this.getMinSec())&&$("#dsp_time").text(n)):++s)}}function setGameCanvas(e){var t=CE.defines("canvas_id").extend(Input),s=e;t.Scene["new"]({name:"MyScene",materials:{images:{player:"images/knight.png",tileset:"images/grass_tileset_2x.png",trail1:"images/trail_dot1.png",trail2:"images/trail_dot2.png",trail3:"images/trail_dot3.png",trail4:"images/trail_dot4.png"}},ready:function(e){var n=$(document).width(),a=$(window).height(),i=$(window).width();$("#bgcanvas").css("left",i/2-$("#bgcanvas")[0].width/2),$("#canvas_id").css("left",i/2-$("#canvas_id")[0].width/2);var o={image:"tileset",size:[8,6],tile:[64,64],reg:[0,0],set:["none_0","n_0","e_0","ne_0","s_0","ns_0","es_0","nes_0","none_1","n_1","e_1","ne_1","s_1","ns_1","es_1","nes_1","none_2","n_2","e_2","ne_2","s_2","ns_2","es_2","nes_2","w_0","nw_0","ew_0","new_0","sw_0","nsw_0","esw_0","nesw_0","w_1","nw_1","ew_1","new_1","sw_1","nsw_1","esw_1","nesw_1","w_2","nw_2","ew_2","new_2","sw_2","nsw_2","esw_2","nesw_2"],cells:[[{x:0,y:0,tiles:["none_0","none_1","none_2"]}],[{x:0,y:0,tiles:["n_0","n_1","n_2"]}],[{x:0,y:0,tiles:["e_0","e_1","e_2"]}],[{x:0,y:0,tiles:["ne_0","ne_1","ne_2"]}],[{x:0,y:0,tiles:["s_0","s_1","s_2"]}],[{x:0,y:0,tiles:["ns_0","ns_1","ns_2"]}],[{x:0,y:0,tiles:["es_0","es_1","es_2"]}],[{x:0,y:0,tiles:["nes_0","nes_1","nes_2"]}],[{x:0,y:0,tiles:["w_0","w_1","w_2"]}],[{x:0,y:0,tiles:["nw_0","nw_1","nw_2"]}],[{x:0,y:0,tiles:["ew_0","ew_1","ew_2"]}],[{x:0,y:0,tiles:["new_0","new_1","new_2"]}],[{x:0,y:0,tiles:["sw_0","sw_1","sw_2"]}],[{x:0,y:0,tiles:["nsw_0","nsw_1","nsw_2"]}],[{x:0,y:0,tiles:["esw_0","esw_1","esw_2"]}],[{x:0,y:0,tiles:["nesw_0","nesw_1","nesw_2"]}]],entrances:this.cells,exits:this.cells},r={bg:"#17d540",spritemap:o,cellSize:[64,64]};this.mazeRenderer=new AMaze.render.MazeRenderer({bgcanvas:$("#bgcanvas")[0],canvasEngine:t,scene:this,stage:e,maze:s,style:r}),this.mazeRenderer.createTrailModel(),this.mazeRenderer.drawMaze(),mouseAction.setMazeModel(s),s.userData=new userData(Date.now()),s.gameData=gameData,resetStatus(),t.Input.keyUp(Input.Up,function(e){!inputLock&&s.movePlayer(AMaze.model.N_CONST)?updateStatus(s):soundWizzard.playObstacle()}),t.Input.keyUp(Input.Bottom,function(e){!inputLock&&s.movePlayer(AMaze.model.S_CONST)?updateStatus(s):soundWizzard.playObstacle()}),t.Input.keyUp(Input.Left,function(e){!inputLock&&s.movePlayer(AMaze.model.W_CONST)?updateStatus(s):soundWizzard.playObstacle()}),t.Input.keyUp(Input.Right,function(e){!inputLock&&s.movePlayer(AMaze.model.E_CONST)?updateStatus(s):soundWizzard.playObstacle()})},render:function(e){this.mazeRenderer.refresh(),e.refresh(),s.userData.displayMinSec()}}),t.ready().Scene.call("MyScene")}currentMazeFile="",currentLevel=0,currentMaze=-1,mazeDirectory={small:["maze1_2x3","maze2_3x3","maze3_10x10","maze4_10x10","maze5_8x5","maze6_10x5","maze7_4x7","maze8_10x10"],medium:[],large:[],huge:[]};var localDB=!1,inputLock=!1,mouseAction={},remoteDB={user:"anonymous",pass:"",sectionTimestamp:0,isLogon:!1,url:"http://axemaze-db.herokuapp.com",categories:[],mazeCategory:[,,,],mazeTotal:0,firstMazeNo:0,currMazeObj:{},HTTPGet:function(e){return $.ajax({type:"GET",url:this.url+e,async:!1}).responseText},HTTPGetAsync:function(e,t){$.ajax({type:"GET",url:this.url+e,success:function(e){t(e)},error:function(e,t,s){console.log(e.status,e.responseText,t,s)}})},initiate:function(){this.categories=JSON.parse(this.HTTPGet("/categories")),this.mazeTotal=JSON.parse(this.HTTPGet("/mazes")).mazes,this.mazeCategory[0]=JSON.parse(this.HTTPGet("/mazes/category/1")),this.HTTPGetAsync("/mazes/category/101",function(e){this.mazeCategory[1]=JSON.parse(e)});var e=$.ajax({type:"GET",url:this.url+"/mazes/category/201",async:!1}).responseText;this.mazeCategory[2]=JSON.parse(e);var e=$.ajax({type:"GET",url:this.url+"/mazes/category/301",async:!1}).responseText;this.mazeCategory[3]=JSON.parse(e),this.firstMazeNo=this.mazeCategory[currentLevel].mazes[0].mazeno},getNextMaze:function(){if(++currentMaze,currentMaze>=this.mazeTotal)return{};var e=$.ajax({type:"GET",url:this.url+"/maze/"+(currentMaze+this.firstMazeNo).toString(),async:!1}).responseText,t;return this.currentMaze=JSON.parse((t=JSON.parse(e)).mazeJSON),currentMazeFile=t.displayName,this.currentMaze}},gameData=new function(){this.totalStep=0,this.totalTime=0,this.totalScore=0;var e,t;this.keepStep=function(t){this.totalStep+=e=t},this.keepTime=function(e){this.totalTime+=t=e},this.getScore=function(){var s=Math.round(50*(1+.6*currentMaze)-e-3*t);return this.totalScore+=0>s?0:s,this.totalScore}},soundWizzard={isActive:!1,currSong:0,musicFiles:["sound/Anguish.mp3","sound/Mellowtron.mp3"],soundFiles:{intro:["sound/intro.mp3",1e3],winner:["sound/winner.mp3",4214],step:["sound/step.mp3",470],block:["sound/nogo.mp3",287],finale:""},playList:[],initiate:function(){buzz.isSupported()?(this.isActive=!0,this.playList.push(new buzz.sound(this.musicFiles[1]))):this.isActive=!1,""!=this.soundFiles.intro&&(this.intro=new buzz.sound(this.soundFiles.intro[0],{preload:!0}),this.introPause=this.soundFiles.intro[1]),""!=this.soundFiles.winner&&(this.winner=new buzz.sound(this.soundFiles.winner[0],{preload:!0,volumne:90}),this.winnerPause=this.soundFiles.winner[1]),""!=this.soundFiles.step&&(this.step=new buzz.sound(this.soundFiles.step[0],{preload:!0,volumne:90}),this.stepPause=this.soundFiles.step[1]),""!=this.soundFiles.block&&(this.block=new buzz.sound(this.soundFiles.block[0],{preload:!0,volumne:90}),this.blockPause=this.soundFiles.block[1]),""!=this.soundFiles.finale&&(this.finale=new buzz.sound(this.soundFiles.finale[0],{preload:!0}),this.finalePause=this.soundFiles.finale[1])},playMusic:function(){this.isActive&&(this.playList[soundWizzard.currSong].play(),this.playList[soundWizzard.currSong].loop())},stopMusic:function(){this.isActive&&this.playList[soundWizzard.currSong].stop()},pauseMusic:function(){this.isActive&&this.playList[soundWizzard.currSong].pause()},playIntro:function(){void 0!==this.intro&&this.intro.play()},playWinner:function(){void 0!==this.winner&&this.winner.play()},playfinale:function(){void 0!==this.finale&&this.finale.play()},playStep:function(){void 0!==this.step&&this.step.play()},playObstacle:function(){void 0!==this.block&&this.block.play()}},mouseWorkEngine=function(e){function t(e){if(this.inputLock)return!1;var t=!0;switch(e){case 2:(t=u.movePlayer(AMaze.model.E_CONST))&&updateStatus(u);break;case 4:(t=u.movePlayer(AMaze.model.W_CONST))&&updateStatus(u);break;case 3:(t=u.movePlayer(AMaze.model.S_CONST))&&updateStatus(u);break;case 1:(t=u.movePlayer(AMaze.model.N_CONST))&&updateStatus(u)}return t}function s(e){m=!0,h=o(e),f=r(e)}function n(e){if(m&&Date.now()-w>100){M=(g=o(e))-h,x=(v=r(e))-f;var s=Math.abs(M),n=Math.abs(x),a,i;w=Date.now(),(s>l||n>l)&&(s>n?(x=0,a=M>0?2:4,i=Math.max(0,(d-c)*(1-(s-l)/p/l))):(M=0,a=x>0?3:1,i=Math.max(0,(d-c)*(1-(n-l)/p/l))),h=g,f=v,clearInterval(_),_=0,t(a)&&(y=a,_=setInterval(function(){t(a)||(clearInterval(_),_=0)},c+i)))}}function a(e){m=!1,cleanInterval(_),_=0,w=0,y=0}function i(e){m=!1,clearInterval(_),_=0,w=0,y=0}function o(t){return Math.floor(t.clientX-e.offsetLeft)}function r(t){return Math.floor(t.clientY-e.offsetTop)}this.inputLock=!1;var u,l=8,c=500,d=1e3,p=3,m=!1,z=!1,_,h=-1,f=-1,y=0,w=0,g,v,M,x,z,S;e.addEventListener("mousedown",function(e){s(e)}),e.addEventListener("mousemove",function(e){n(e)}),e.addEventListener("mouseup",function(e){i(e)}),this.setMazeModel=function(e){u=e}};$(function(){soundWizzard.initiate(),mouseAction=new mouseWorkEngine(document.getElementById("canvas_id")),localDB?(currentMazeFile=getNextMaze(),AMaze.model.load(currentMazeFile,setGameCanvas)):(remoteDB.initiate(),AMaze.model.inject(remoteDB.getNextMaze(),setGameCanvas)),$(window).on("keydown",function(e){[32,37,38,39,40].indexOf(e.keyCode)>-1&&e.preventDefault()}).scrollTop(0).scrollLeft(0),$("#menu_new").click(function(){confirm("Are you sure you want to restart this level?")&&AMaze.model.load(currentMazeFile,setGameCanvas)}),$("#menu_goto").click(function(){console.log("goto button is pressed.")}),$("#menu_level").click(function(){console.log("level button is pressed.")}),$("#menu_save").click(function(){console.log("save button is pressed.")}),$("#menu_load").click(function(){console.log("load button is pressed.")})}),"undefined"!=typeof exports&&(module.exports.getNextMaze=getNextMaze,module.exports.updateStatus=updateStatus,module.exports.resetStatus=resetStatus,module.exports.userData=userData,module.exports.setGameCanvas=setGameCanvas,module.exports.gameData=gameData,module.exports.soundWizzard=soundWizzard);